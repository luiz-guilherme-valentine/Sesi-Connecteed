<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerenciar Notícias</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .noticia { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 8px; }
    .noticia h3 { margin: 0; }
    .botoes { margin-top: 10px; }
    button { margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Gerenciar Notícias</h1>

  <form id="formNoticia" enctype="multipart/form-data">
    <input type="text" name="titulo" placeholder="Título" required><br><br>
    <input type="text" name="autores" placeholder="Autores" required><br><br>
    <textarea name="conteudo" placeholder="Conteúdo"></textarea><br><br>
    <label>PDF (opcional): <input type="file" name="pdf" accept="application/pdf"></label><br><br>
    <label>Capa (opcional): <input type="file" name="capa" accept="image/*"></label><br><br>
    <button type="submit">Enviar Notícia</button>
  </form>

  <hr>
  <button onclick="fazerBackup()">Fazer Backup</button>
  <input type="file" id="restoreFile" style="display:none" onchange="restaurarBackup(this)">
  <button onclick="document.getElementById('restoreFile').click()">Restaurar Backup</button>

  <h2>Lista de Notícias</h2>
  <div id="listaNoticias"></div>

  <script>
    const API_URL = "https://sesi-connecteed.onrender.com"; // <<-- TROQUE PELO SEU SERVER

    async function carregarNoticias() {
      try {
        const res = await fetch(API_URL + "/noticias");
        if (!res.ok) throw new Error("Falha no servidor");
        const noticias = await res.json();

        const lista = document.getElementById("listaNoticias");
        lista.innerHTML = "";

        if (noticias.length === 0) {
          lista.innerHTML = "<p>Nenhuma notícia cadastrada.</p>";
          return;
        }

        noticias.forEach(noticia => {
          const div = document.createElement("div");
          div.className = "noticia";
          div.innerHTML = `
            <h3>${noticia.titulo}</h3>
            <p><strong>Autores:</strong> ${noticia.autores}</p>
            <p>${noticia.conteudo}</p>
            ${noticia.capa ? `<img src="${API_URL}${noticia.capa}" width="200">` : ""}
            <div class="botoes">
              ${noticia.pdf ? `<a href="${API_URL}${noticia.pdf}" download>Baixar PDF</a>` : ""}
              <button onclick="deletarNoticia('${noticia.id}')">Deletar</button>
            </div>
          `;
          lista.appendChild(div);
        });
      } catch (err) {
        console.error("Erro ao buscar notícias", err);
        alert("Erro ao carregar notícias.");
      }
    }

    document.getElementById("formNoticia").addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      try {
        const res = await fetch(API_URL + "/noticias", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("Erro no envio");
        await carregarNoticias();
        e.target.reset();
      } catch (err) {
        alert("Erro ao enviar notícia.");
        console.error(err);
      }
    });

    async function deletarNoticia(id) {
      if (!confirm("Deseja realmente deletar?")) return;
      try {
        const res = await fetch(API_URL + "/noticias/" + id, { method: "DELETE" });
        if (!res.ok) throw new Error("Erro ao deletar");
        await carregarNoticias();
      } catch (err) {
        alert("Erro ao deletar notícia.");
        console.error(err);
      }
    }

    async function fazerBackup() {
      try {
        const res = await fetch(API_URL + "/backup");
        if (!res.ok) throw new Error("Erro no backup");
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "backup_noticias.zip";
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (err) {
        alert("Erro ao fazer backup");
      }
    }

    async function restaurarBackup(input) {
      if (!input.files[0]) return;
      const formData = new FormData();
      formData.append("backup", input.files[0]);

      try {
        const res = await fetch(API_URL + "/restore", {
          method: "POST",
          body: formData
        });
        if (!res.ok) throw new Error("Erro na restauração");
        alert("Backup restaurado com sucesso!");
        await carregarNoticias();
      } catch (err) {
        alert("Erro ao restaurar backup.");
        console.error(err);
      }
    }

    carregarNoticias();
  </script>
</body>
</html>
